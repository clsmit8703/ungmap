{% extends 'base.html' %}

{% block moreheader %}
<script src='https://api.tiles.mapbox.com/mapbox.js/v1.6.3/mapbox.js'></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<link href='https://api.tiles.mapbox.com/mapbox.js/v1.6.3/mapbox.css' rel="stylesheet"/>
<style> #map {position:absolute; top:50px; right:10px;left:6px;bottom:0;width:100%;
    height:1000px;}</style>
{% endblock %}

<a href='#' id='geolocate' class='ui-button'>Find me</a>
{% block content %}
    <div class="row">
        <div class="col-md-8">
            {% if campus.pic.pic %}
                <p><img src="{{ MEDIA_URL }}{{ campus.pic.pic }}" width=100% height=auto></p>
                <br>
            {% else %}
                <p>No image exists at this time</p>
            {% endif %}
        </div>
        <div class="col-md-4">
            <p><b> {{ campus.name|capfirst }}</b><br>
                <b>{{ campus.location }}</b>
        </div>
    </div>
    <a href="{% url 'map:building_lview' campus.pk %}">View Buildings</a><br>
    <a href="{% url 'map:parkinglot_lview' campus.pk %}">View Parking Lots</a><br>
    <a href="{% url 'map:faculty_lview' campus.pk %}">View Faculty Members</a>
    <br>
    <div class="row clearfix">
    <div class= "col-md-12 column">
    <div id="map"></div>
        <a href='#' id='geolocate' class='ui-button'>Find me</a>
        <style>
        .ui-button {
  background:#3887BE;
  color:#FFF;
  display:block;
  position:absolute;
  top:50%;left:50%;
  width:160px;
  margin:-20px 0 0 -80px;
  z-index:100;
  text-align:center;
  padding:10px;
  border:1px solid rgba(0,0,0,0.4);
  border-radius:3px;
  }
  .ui-button:hover {
    background:#3074a4;
    color:#fff;
    }
    </style>
    </div>
    </div>

{% endblock %}


{% block scriptspace %}
    <script>
    L.mapbox.accessToken = 'pk.eyJ1IjoiY2xzbWl0ODcwMyIsImEiOiJGcEo5d1U4In0.lyzUE4Dmep0FyyDntU04Kg';
    var geolocate = document.getElementById('geolocate');
    var map= L.mapbox.map('map','wc351.k6p7ha1o');
    var myLayer = L.mapbox.featureLayer().addTo(map);
    if (!navigator.geolocation) {
    geolocate.innerHTML = 'Geolocation is not available';
} else {
    geolocate.onclick = function (e) {
        e.preventDefault();
        e.stopPropagation();
        map.locate();
    };
}

// Once we've got a position, zoom and center the map
// on it, and add a single marker.
map.on('locationfound', function(e) {
    map.fitBounds(e.bounds);

    myLayer.setGeoJSON({
        type: 'Feature',
        geometry: {
            type: 'Point',
            coordinates: [e.latlng.lng, e.latlng.lat]
        },
        properties: {
            'title': 'Here I am!',
            'marker-color': '#ff8888',
            'marker-symbol': 'star'
        }
    });

    // And hide the geolocation button
    geolocate.parentNode.removeChild(geolocate);
});

// If the user chooses not to allow their location
// to be shared, display an error message.
map.on('locationerror', function() {
    geolocate.innerHTML = 'Position could not be found';
});
     map.fitBounds([[{{ campus.box.extent.3 }}, {{ campus.box.extent.0 }}],
                  [{{ campus.box.extent.1 }}, {{ campus.box.extent.2 }}]]);
    map.setMaxBounds([[{{ campus.box.extent.3 }}, {{ campus.box.extent.0 }}],
                  [{{ campus.box.extent.1 }}, {{ campus.box.extent.2 }}]]);
    var g_parkinglots = {
        fillColor: "#ff7800",
        color: "#000",
        weight: 1,
        opacity: 0.08,
        fillOpacity: 0.08
    };
    var g_buildings = {
        fillColor: '#E31A1C',
        color: '#E31A1C',
        weight: 1,
        opacity: 1,
        fillOpacity: 0.8
    };

      $.getJSON( '/api/v1/parkinglots', function (data) {
          L.geoJson(data, {pointToLayer: function (feature, latlng) {
              return L.polygon(latlng, g_parkinglots)
          },
              style: g_parkinglots,
              onEachFeature: function (feature, layer) {
                  (function (layer, properties) {
                      layer.on("click", function (e) {
                          var popup = L.popup().setLatLng(e.latlng)
                                  .setContent('<a href="/popular_places/' + feature.id + '">' + properties.name + '</a>')
                                  .openOn(map);
                      });
                  })(layer, feature.properties);
              }
          }).addTo(map);
      });
     $.getJSON( '/api/v1/buildings', function (data) {
          L.geoJson(data, {pointToLayer: function (feature, latlng) {
              return L.polygon(latlng, g_buildings)
          },
              style: g_buildings,
              onEachFeature: function (feature, layer) {
                  (function (layer, properties) {
                      layer.on("click", function (e) {
                          var popup = L.popup().setLatLng(e.latlng)
                                  .setContent('<a href="/popular_places/' + feature.id + '">' + properties.name + '</a>')
                                  .openOn(map);
                      });
                  })(layer, feature.properties);
              }
          }).addTo(map);
      });
    </script>
{% endblock %}